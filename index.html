<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interactive Quiz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --success: #00b894;
            --error: #ff7675;
            --bg: #f0f2f5;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #app-container {
            width: 95%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }

        .hidden { display: none !important; }

        /* AI Host Styling */
        #ai-host {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            position: relative;
        }

        .character-svg { width: 100%; height: 100%; }
        .eye { fill: #333; transition: 0.2s; }
        .wink { height: 2px !important; } /* Winking effect */
        
        .bubble {
            background: #fff;
            border: 2px solid var(--primary);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            position: relative;
        }

        /* UI Elements */
        input {
            width: 80%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:active { transform: scale(0.95); }

        .option-btn {
            display: block;
            width: 100%;
            margin: 10px 0;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            text-align: left;
        }

        .correct { background: var(--success) !important; color: white; }
        .wrong { background: var(--error) !important; color: white; }

        /* Report Preview (Hidden) */
        #report-template {
            width: 800px;
            padding: 40px;
            background: white;
            position: absolute;
            left: -9999px;
            top: 0;
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="entry-screen">
        <h2>Welcome to the Quiz!</h2>
        <p>Enter your details to start</p>
        <input type="text" id="userName" placeholder="Your Full Name" required>
        <input type="tel" id="userMobile" placeholder="Mobile Number" required>
        <br><br>
        <button onclick="startQuiz()">Start Quiz</button>
    </div>

    <div id="quiz-screen" class="hidden">
        <div id="ai-host">
            <svg class="character-svg" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" fill="#ffe0bd"/>
                <circle class="eye left-eye" cx="35" cy="40" r="5" />
                <circle class="eye right-eye" cx="65" cy="40" r="5" />
                <path id="mouth" d="M 35 70 Q 50 80 65 70" stroke="#333" stroke-width="3" fill="transparent" />
            </svg>
        </div>
        <div class="bubble" id="ai-speech">Hello! I'm your host. Good luck!</div>
        
        <h3 id="question-text">Loading question...</h3>
        <div id="options-container"></div>
        <p>Question <span id="q-count">1</span>/20</p>
    </div>

    <div id="result-screen" class="hidden">
        <h2>Quiz Complete!</h2>
        <p id="final-score-text"></p>
        <p>Your report is being generated and downloaded...</p>
        <button onclick="location.reload()">Restart Quiz</button>
    </div>
</div>

<div id="report-template">
    <h1 style="color:#6c5ce7">Quiz Performance Report</h1>
    <hr>
    <div id="report-meta" style="font-size: 20px; margin-bottom: 20px;"></div>
    <table id="report-table" style="width:100%; border-collapse: collapse; text-align: left;">
        <thead>
            <tr style="background: #eee;">
                <th style="padding:10px; border:1px solid #ddd;">Question</th>
                <th style="padding:10px; border:1px solid #ddd;">Your Answer</th>
                <th style="padding:10px; border:1px solid #ddd;">Correct Answer</th>
            </tr>
        </thead>
        <tbody id="report-body"></tbody>
    </table>
</div>

<script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSxcEdtVMVmRWFHzJAE5ZbOnBENM8kuKHwI5SbUBAnkMXBNlHpA-4RqAEhPUCaEaPzL0D8wsEBdAOds/pub?gid=0&single=true&output=csv';
    
    let questions = [];
    let currentQ = 0;
    let score = 0;
    let userData = { name: '', mobile: '' };
    let userLog = []; // Stores answers for report

    // Fetch and Parse CSV
    async function loadQuestions() {
        try {
            const response = await fetch(CSV_URL);
            const data = await response.text();
            const rows = data.split('\n').slice(1); // Skip header
            
            questions = rows.map(row => {
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // Regex to handle commas inside quotes
                return {
                    text: cols[1]?.replace(/"/g, ''),
                    options: [cols[2], cols[3], cols[4], cols[5]],
                    correct: cols[6]?.trim().replace(/"/g, '')
                };
            }).filter(q => q.text); // Remove empty rows

            questions = questions.sort(() => Math.random() - 0.5).slice(0, 20); // Shuffle and take 20
        } catch (e) {
            console.error("Error loading questions:", e);
            alert("Failed to load quiz data. Please check your internet connection.");
        }
    }

    function startQuiz() {
        const name = document.getElementById('userName').value;
        const mobile = document.getElementById('userMobile').value;

        if(!name || !mobile) return alert("Please fill in all details");

        userData = { name, mobile };
        document.getElementById('entry-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        showQuestion();
    }

    function showQuestion() {
        const q = questions[currentQ];
        document.getElementById('q-count').innerText = currentQ + 1;
        document.getElementById('question-text').innerText = q.text;
        document.getElementById('ai-speech').innerText = "Pick the right answer!";
        
        const container = document.getElementById('options-container');
        container.innerHTML = '';

        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(opt, btn);
            container.appendChild(btn);
        });
    }

    function checkAnswer(selected, btn) {
        const correct = questions[currentQ].correct;
        const allBtns = document.querySelectorAll('.option-btn');
        allBtns.forEach(b => b.disabled = true);

        userLog.push({
            q: questions[currentQ].text,
            user: selected,
            correct: correct
        });

        if(selected.trim() === correct.trim()) {
            score++;
            btn.classList.add('correct');
            triggerAIReaction(true);
        } else {
            btn.classList.add('wrong');
            // Highlight the correct one
            allBtns.forEach(b => {
                if(b.innerText.trim() === correct.trim()) b.classList.add('correct');
            });
            triggerAIReaction(false);
        }

        setTimeout(() => {
            currentQ++;
            if(currentQ < 20) {
                showQuestion();
            } else {
                finishQuiz();
            }
        }, 2000);
    }

    function triggerAIReaction(isCorrect) {
        const leftEye = document.querySelector('.left-eye');
        const speech = document.getElementById('ai-speech');
        const mouth = document.getElementById('mouth');

        if(isCorrect) {
            leftEye.classList.add('wink');
            speech.innerText = "Awesome! That's correct! âœ¨";
            mouth.setAttribute('d', 'M 30 70 Q 50 90 70 70'); // Bigger smile
        } else {
            speech.innerText = `Not quite! The correct answer was: ${questions[currentQ].correct}`;
            mouth.setAttribute('d', 'M 35 75 Q 50 75 65 75'); // Flat smile
        }

        setTimeout(() => {
            leftEye.classList.remove('wink');
            mouth.setAttribute('d', 'M 35 70 Q 50 80 65 70');
        }, 1500);
    }

    async function finishQuiz() {
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('final-score-text').innerText = `You scored ${score} out of 20!`;

        generateReport();
    }

    async function generateReport() {
        // Populate Hidden Report
        document.getElementById('report-meta').innerHTML = `
            <strong>Name:</strong> ${userData.name} | <strong>Mobile:</strong> ${userData.mobile}<br>
            <strong>Total Score:</strong> ${score} / 20
        `;

        const body = document.getElementById('report-body');
        userLog.forEach(item => {
            const row = `<tr>
                <td style="padding:8px; border:1px solid #ddd;">${item.q}</td>
                <td style="padding:8px; border:1px solid #ddd; color:${item.user === item.correct ? 'green' : 'red'}">${item.user}</td>
                <td style="padding:8px; border:1px solid #ddd; color:green">${item.correct}</td>
            </tr>`;
            body.innerHTML += row;
        });

        // Convert to Image
        const reportDiv = document.getElementById('report-template');
        const canvas = await html2canvas(reportDiv);
        const link = document.createElement('a');
        link.download = `${userData.name}_Quiz_Report.jpg`;
        link.href = canvas.toDataURL('image/jpeg', 0.9);
        link.click();
    }

    // Initialize
    loadQuestions();
</script>

</body>
</html>
