<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gurwinder Singh Ka Gyan</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf-plugin-autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --primary: #6c5ce7; --success: #00b894; --error: #d63031; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow-x: hidden; }
        #app { width: 95%; max-width: 450px; background: white; border-radius: 25px; padding: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); text-align: center; }
        .hidden { display: none !important; }
        
        /* AI Virtual Host */
        #ai-host { width: 130px; height: 130px; margin: 0 auto; transition: transform 0.3s; }
        .eye { fill: #333; transition: 0.1s; }
        .wink { transform: scaleY(0.1); transform-origin: center 40px; }
        .speech { background: white; border: 2px solid var(--primary); border-radius: 15px; padding: 10px; font-size: 14px; margin-bottom: 15px; font-weight: 500; }

        /* UI Elements */
        input { width: 90%; padding: 15px; margin: 10px 0; border: 2px solid #eee; border-radius: 12px; font-size: 16px; outline: none; }
        input:focus { border-color: var(--primary); }
        .btn-action { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; }
        .option { display: block; width: 100%; padding: 15px; margin: 8px 0; border: 2px solid #eee; border-radius: 12px; background: white; text-align: left; cursor: pointer; font-size: 15px; transition: 0.2s; }
        .correct { background: var(--success) !important; color: white; border-color: var(--success); }
        .wrong { background: var(--error) !important; color: white; border-color: var(--error); }

        /* JPG Export Style (Hidden) */
        #jpg-template { position: absolute; left: -9999px; width: 400px; padding: 40px; background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; text-align: center; border-radius: 20px; }
    </style>
</head>
<body>

<div id="app">
    <div id="screen-entry">
        <h2 style="color: var(--primary)">Gurwinder Singh Ka Gyan</h2>
        <p>Interactive Quiz Contest</p>
        <input type="text" id="name" placeholder="Full Name">
        <input type="tel" id="mobile" placeholder="Mobile Number">
        <button class="btn-action" onclick="startApp()">Enter Contest</button>
    </div>

    <div id="screen-quiz" class="hidden">
        <div id="ai-host">
            <svg viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" fill="#FFDBAC"/>
                <circle class="eye left-eye" cx="35" cy="40" r="5"/>
                <circle class="eye right-eye" cx="65" cy="40" r="5"/>
                <path id="mouth" d="M 35 70 Q 50 80 65 70" stroke="#333" stroke-width="3" fill="none"/>
                <path d="M 20 30 Q 50 5 80 30" stroke="#4a2c2a" stroke-width="12" fill="none"/>
            </svg>
        </div>
        <div class="speech" id="ai-msg">Ready to test your knowledge?</div>
        <h3 id="q-text" style="min-height: 50px;"></h3>
        <div id="options"></div>
        <p style="font-size: 0.8em; color: #888;">Step <span id="q-num">1</span> of 20</p>
    </div>

    <div id="screen-result" class="hidden">
        <h2 style="color: var(--success)">Quiz Completed!</h2>
        <div id="result-info" style="margin: 20px 0; font-size: 1.2em;"></div>
        <p style="color: #666; font-size: 0.9em;">Generating your JPG and PDF reports...</p>
        <button class="btn-action" onclick="location.reload()" style="background: #555;">Restart</button>
    </div>
</div>

<div id="jpg-template">
    <h1 style="margin: 0;">CERTIFICATE</h1>
    <p>of Participation</p>
    <div style="margin: 30px 0;">
        <h2 id="jpg-name" style="text-decoration: underline;"></h2>
        <p id="jpg-mob"></p>
    </div>
    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
        <span style="font-size: 1.5em;">Score: <span id="jpg-score"></span>/20</span>
    </div>
    <p style="margin-top: 40px; font-size: 0.8em;">Gurwinder Singh Ka Gyan Contest</p>
</div>

<audio id="bg-music" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3"></audio>

<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSxcEdtVMVmRWFHzJAE5ZbOnBENM8kuKHwI5SbUBAnkMXBNlHpA-4RqAEhPUCaEaPzL0D8wsEBdAOds/pub?gid=0&single=true&output=csv";
    
    let quizData = [], current = 0, score = 0;
    let user = { name: '', mobile: '' }, logs = [];

    // 1. Initial Logic
    async function startApp() {
        user.name = document.getElementById('name').value;
        user.mobile = document.getElementById('mobile').value;
        if(!user.name || !user.mobile) return alert("Fill details!");

        document.getElementById('bg-music').play().catch(() => {}); // Play music

        try {
            const res = await fetch(CSV_URL);
            const text = await res.text();
            const rows = text.split('\n').slice(1);
            
            quizData = rows.map(r => {
                const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return {
                    q: c[1]?.replace(/"/g, ''),
                    o: [c[2], c[3], c[4], c[5]],
                    a: c[6]?.trim().replace(/"/g, '')
                };
            }).filter(x => x.q).sort(() => Math.random() - 0.5).slice(0, 20);

            document.getElementById('screen-entry').classList.add('hidden');
            document.getElementById('screen-quiz').classList.remove('hidden');
            loadQuestion();
        } catch(e) { alert("Error loading quiz data."); }
    }

    // 2. Quiz Logic
    function loadQuestion() {
        const item = quizData[current];
        document.getElementById('q-text').innerText = item.q;
        document.getElementById('q-num').innerText = current + 1;
        const box = document.getElementById('options');
        box.innerHTML = '';
        
        item.o.forEach(opt => {
            const b = document.createElement('button');
            b.className = 'option';
            b.innerText = opt;
            b.onclick = () => handleChoice(opt, b);
            box.appendChild(b);
        });
    }

    function handleChoice(sel, btn) {
        const correct = quizData[current].a;
        const btns = document.querySelectorAll('.option');
        btns.forEach(b => b.disabled = true);
        
        const isCorrect = (sel === correct);
        if(isCorrect) score++;

        logs.push({ q: quizData[current].q, user: sel, correct: correct, result: isCorrect ? 'Correct' : 'Incorrect' });

        // AI Reaction
        const eye = document.querySelector('.right-eye');
        const mouth = document.getElementById('mouth');
        const msg = document.getElementById('ai-msg');

        if(isCorrect) {
            btn.classList.add('correct');
            eye.classList.add('wink');
            msg.innerText = "Wow! You are brilliant! âœ¨";
            mouth.setAttribute('d', 'M 30 70 Q 50 90 70 70');
        } else {
            btn.classList.add('wrong');
            msg.innerText = `Keep trying! The answer was ${correct}`;
            mouth.setAttribute('d', 'M 35 75 Q 50 75 65 75');
            btns.forEach(b => { if(b.innerText === correct) b.classList.add('correct'); });
        }

        setTimeout(() => {
            eye.classList.remove('wink');
            mouth.setAttribute('d', 'M 35 70 Q 50 80 65 70');
            current++;
            if(current < quizData.length) loadQuestion();
            else finishContest();
        }, 2200);
    }

    // 3. Finalization & Report Generation
    async function finishContest() {
        document.getElementById('screen-quiz').classList.add('hidden');
        document.getElementById('screen-result').classList.remove('hidden');
        document.getElementById('result-info').innerHTML = `<b>${user.name}</b><br>Your Score: ${score}/20`;

        // -- GENERATE JPG --
        document.getElementById('jpg-name').innerText = user.name;
        document.getElementById('jpg-mob').innerText = user.mobile;
        document.getElementById('jpg-score').innerText = score;
        
        const jpgArea = document.getElementById('jpg-template');
        const canvas = await html2canvas(jpgArea);
        const jpgLink = document.createElement('a');
        jpgLink.download = `${user.name}_Result.jpg`;
        jpgLink.href = canvas.toDataURL("image/jpeg");
        jpgLink.click();

        // -- GENERATE PDF --
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(20);
        doc.setTextColor(108, 92, 231);
        doc.text("Gurwinder Singh Ka Gyan", 105, 15, { align: "center" });
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text(`Participant: ${user.name}`, 14, 25);
        doc.text(`Mobile: ${user.mobile}`, 14, 30);
        doc.text(`Final Score: ${score}/20`, 14, 35);
        doc.text(`Date: ${new Date().toLocaleString()}`, 14, 40);

        const tableRows = logs.map((l, i) => [i + 1, l.q, l.user, l.correct, l.result]);
        
        doc.autoTable({
            startY: 45,
            head: [['#', 'Question', 'Your Choice', 'Correct Answer', 'Status']],
            body: tableRows,
            theme: 'grid',
            headStyles: { fillColor: [108, 92, 231] },
            columnStyles: { 1: { cellWidth: 80 } }
        });

        doc.save("Gurwinder Singh Ka Gyan.pdf");
    }
</script>
</body>
</html>
